{% load static %}
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Consulta - MediPulse</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ Agendar Consulta</h1>
            <div class="user-info">
                <span>{{ request.user.nome }}</span>
                <a href="{% url 'logout' %}" class="logout-btn">Sair</a>
            </div>
        </div>

        <div class="nav-menu">
            <a href="{% url 'patient_home' %}">üè† Home</a>
            <a href="{% url 'marcar_consulta' %}" class="active">üìÖ Agendar Consulta</a>
            <a href="{% url 'listar_consultas' %}">üè• As Minhas Consultas</a>
            <a href="{% url 'listar_faturas' %}">üí∞ Faturas</a>
        </div>

        <div class="content-section">
            <h2>Procurar Disponibilidades</h2>
            <p>Use os filtros para procurar disponibilidades. Depois marque um slot dispon√≠vel.</p>

            <form method="get">
                <div class="form-row">
                    <div class="form-group">
                        <label>Especialidade</label>
                        <select name="especialidade">
                            <option value="">(Todas)</option>
                            {% for e in especialidades %}
                            <option value="{{ e.id_especialidade }}" {% if selected.especialidade == e.id_especialidade|stringformat:"s" %}selected{% endif %}>{{ e.nome_especialidade }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unidade</label>
                        <select name="unidade">
                            <option value="">(Todas)</option>
                            {% for u in unidades %}
                            <option value="{{ u.id_unidade }}" {% if selected.unidade == u.id_unidade|stringformat:"s" %}selected{% endif %}>{{ u.nome_unidade }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>M√©dico</label>
                        <select name="medico">
                            <option value="">(Qualquer)</option>
                            {% for m in medicos %}
                            <option value="{{ m.id_medico }}" {% if selected.medico == m.id_medico|stringformat:"s" %}selected{% endif %}>
                                {{ m.nome }} 
                                {% if m.especialidade != "Sem especialidade" %} ‚Äî {{ m.especialidade }}{% endif %}
                                {% if not m.tem_disponibilidade %} (Sem disponibilidade nesta unidade){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" name="data" value="{{ selected.data }}">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">üîç Procurar</button>
            </form>
        </div>

        {% if disponibilidades and disponibilidades|length > 0 %}
        <div class="content-section">
            <h2>Resultados ({{ disponibilidades|length }} disponibilidade{% if disponibilidades|length > 1 %}s{% endif %})</h2>
            {% for d in disponibilidades %}
            <div class="slot">
                <div class="slot-info">
                    <h4>{{ d.medico_nome }}</h4>
                    <p>
                        üè• {{ d.unidade_nome }}
                        {% if d.especialidade_nome != "Sem especialidade" %}
                        | üî¨ {{ d.especialidade_nome }}
                        {% endif %}
                        <br>
                        üìÖ {{ d.data|date:"d/m/Y" }}
                        ‚Ä¢ üïí {{ d.hora_inicio }} - {{ d.hora_fim }}
                        ‚Ä¢ ‚è±Ô∏è {{ d.duracao_slot }} minutos por slot
                    </p>
                </div>
                <form method="post" action="{% url 'marcar_consulta' %}">
                    {% csrf_token %}
                    <input type="hidden" name="disponibilidade_id" value="{{ d.id_disponibilidade }}">
                    <div class="form-group" style="margin-top: 10px;">
                        <label for="hora_consulta_{{ d.id_disponibilidade }}">Selecione o hor√°rio de in√≠cio:</label>
                        <select name="hora_consulta" id="hora_consulta_{{ d.id_disponibilidade }}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">Escolha um hor√°rio...</option>
                            {% comment %} Gerar slots de tempo baseados na dura√ß√£o {% endcomment %}
                            {% with start_time=d.hora_inicio end_time=d.hora_fim duration=d.duracao_slot %}
                                {% for slot in d.slots %}
                                    {% if slot.available %}
                                        <option value="{{ slot.time }}">
                                            {{ slot.time }}
                                        </option>
                                    {% else %}
                                        <option value="{{ slot.time }}" disabled>
                                            {{ slot.time }} (Ocupado)
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success" style="margin-top: 10px;">‚úÖ Marcar</button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% elif 'especialidade' in request.GET or 'unidade' in request.GET or 'medico' in request.GET or 'data' in request.GET %}
        <div class="content-section">
            <p style="text-align: center; color: #666; padding: 20px;">
                Nenhuma disponibilidade encontrada com esses filtros.<br>
                Tente alterar os filtros ou remover a data.
            </p>
        </div>
        {% endif %}
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const especialidadeSelect = document.querySelector('[name="especialidade"]');
        const unidadeSelect = document.querySelector('[name="unidade"]');
        const medicoSelect = document.querySelector('[name="medico"]');
        const dataInput = document.querySelector('[name="data"]');
        
        // Fun√ß√£o para atualizar filtros
        function updateFilters() {
            const url = new URL(window.location.pathname, window.location.origin);
            
            if (especialidadeSelect.value) {
                url.searchParams.set('especialidade', especialidadeSelect.value);
            }
            if (unidadeSelect.value) {
                url.searchParams.set('unidade', unidadeSelect.value);
            }
            if (medicoSelect.value) {
                url.searchParams.set('medico', medicoSelect.value);
            }
            if (dataInput.value) {
                url.searchParams.set('data', dataInput.value);
            }
            
            window.location.href = url.toString();
        }
        
        // Adicionar event listeners
        if (especialidadeSelect) {
            especialidadeSelect.addEventListener('change', function() {
                // Limpar m√©dico quando especialidade muda
                if (medicoSelect) medicoSelect.value = '';
                updateFilters();
            });
        }
        
        if (unidadeSelect) {
            unidadeSelect.addEventListener('change', function() {
                // Limpar m√©dico quando unidade muda
                if (medicoSelect) medicoSelect.value = '';
                updateFilters();
            });
        }
        
        if (medicoSelect) {
            medicoSelect.addEventListener('change', updateFilters);
        }
        
        if (dataInput) {
            dataInput.addEventListener('change', updateFilters);
        }
        
        // Adicionar um bot√£o para limpar filtros
        const filterForm = document.querySelector('form[method="get"]');
        const clearButton = document.createElement('button');
        clearButton.type = 'button';
        clearButton.className = 'btn btn-secondary';
        clearButton.textContent = 'üßπ Limpar Filtros';
        clearButton.style.marginLeft = '10px';
        clearButton.addEventListener('click', function() {
            window.location.href = "{% url 'marcar_consulta' %}";
        });
        
        const submitButton = filterForm.querySelector('button[type="submit"]');
        submitButton.parentNode.insertBefore(clearButton, submitButton.nextSibling);
    });
    </script>
</body>
</html>