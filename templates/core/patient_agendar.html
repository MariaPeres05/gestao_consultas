<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Agendar Consulta</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f7fafc;padding:30px}
    .box{max-width:1000px;margin:0 auto;background:#fff;padding:24px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    .filters{display:flex;gap:12px;flex-wrap:wrap}
    select,input[type=date]{padding:8px;border-radius:6px;border:1px solid #dbe6f2}
    .slot{border:1px solid #eef6ff;padding:12px;border-radius:8px;margin:8px 0;display:flex;justify-content:space-between;align-items:center}
    .btn{background:#0b64d1;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none}
    .muted{color:#666;font-size:0.95rem}
  </style>
</head>
<body>
  <div class="box">
    <h2>Agendar Consulta</h2>
    <p class="muted">Use os filtros para procurar disponibilidades. Depois marque um slot disponível.</p>

    <form method="get" class="filters" style="margin-top:12px">
      <div>
        <label>Especialidade<br>
          <select name="especialidade">
            <option value="">(Todas)</option>
            {% for e in especialidades %}
              <option value="{{ e.id_especialidade }}" {% if selected.especialidade == e.id_especialidade|stringformat:"s" %}selected{% endif %}>{{ e.nome_especialidade }}</option>
            {% endfor %}
          </select>
        </label>
      </div>

      <div>
        <label>Unidade<br>
          <select name="unidade">
            <option value="">(Todas)</option>
            {% for u in unidades %}
              <option value="{{ u.id_unidade }}" {% if selected.unidade == u.id_unidade|stringformat:"s" %}selected{% endif %}>{{ u.nome_unidade }}</option>
            {% endfor %}
          </select>
        </label>
      </div>

      <div>
        <label>Médico<br>
          <select name="medico">
            <option value="">(Qualquer)</option>
            {% for m in medicos %}
              <option value="{{ m.id_medico }}" {% if selected.medico == m.id_medico|stringformat:"s" %}selected{% endif %}>{{ m.id_utilizador.nome }}{% if m.numero_ordem %} — {{ m.numero_ordem }}{% endif %}</option>
            {% endfor %}
          </select>
        </label>
      </div>

      <div>
        <label>Data<br>
          <input type="date" name="data" value="{{ selected.data }}">
        </label>
      </div>

      <div style="align-self:end">
        <button type="submit" class="btn">Procurar</button>
      </div>
    </form>

    <hr style="margin:18px 0">

    {% if disponibilidades and disponibilidades|length > 0 %}
      <h3>Disponibilidades encontradas ({{ disponibilidades|length }})</h3>
      <div>
        {% for d in disponibilidades %}
          <div class="slot">
            <div>
              <div><strong>{{ d.id_medico.id_utilizador.nome }}</strong> — {{ d.id_medico.id_especialidade.nome_especialidade }}</div>
              <div class="muted">{{ d.id_unidade.nome_unidade }} — {{ d.data }} às {{ d.hora_inicio }}</div>
            </div>
            <div>
              <form method="post" style="margin:0">
                {% csrf_token %}
                <input type="hidden" name="disponibilidade_id" value="{{ d.id_disponibilidade }}">
                <button type="submit" class="btn">Marcar</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">Nenhuma disponibilidade encontrada com esses filtros. Tente alterar os filtros ou remover a data.</p>
    {% endif %}

    <p style="margin-top:18px"><a href="{% url 'patient_home' %}">Voltar à área do paciente</a></p>
  </div>
</body>
</html>
