{% load static %}
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Consulta - MediPulse</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“… Agendar Consulta</h1>
            <div class="user-info">
                <span>{{ request.user.nome }}</span>
                <a href="{% url 'logout' %}" class="logout-btn">Sair</a>
            </div>
        </div>

        <div class="nav-menu">
            <a href="{% url 'patient_home' %}">ğŸ  Home</a>
            <a href="{% url 'marcar_consulta' %}" class="active">ğŸ“… Agendar Consulta</a>
            <a href="{% url 'listar_consultas' %}">ğŸ¥ Minhas Consultas</a>
            <a href="{% url 'listar_faturas' %}">ğŸ’° Faturas</a>
        </div>

        <div class="content-section">
            <h2>Procurar Disponibilidades</h2>
            <p>Use os filtros para procurar disponibilidades. Depois marque um slot disponÃ­vel.</p>

            <form method="get">
                <div class="form-row">
                    <div class="form-group">
                        <label>Especialidade</label>
                        <select name="especialidade">
                            <option value="">(Todas)</option>
                            {% for e in especialidades %}
                            <option value="{{ e.id_especialidade }}" {% if selected.especialidade == e.id_especialidade|stringformat:"s" %}selected{% endif %}>{{ e.nome_especialidade }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unidade</label>
                        <select name="unidade">
                            <option value="">(Todas)</option>
                            {% for u in unidades %}
                            <option value="{{ u.id_unidade }}" {% if selected.unidade == u.id_unidade|stringformat:"s" %}selected{% endif %}>{{ u.nome_unidade }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>MÃ©dico</label>
                        <select name="medico">
                            <option value="">(Qualquer)</option>
                            {% for m in medicos %}
                            <option value="{{ m.id_medico }}" {% if selected.medico == m.id_medico|stringformat:"s" %}selected{% endif %}>{{ m.id_utilizador.nome }}{% if m.numero_ordem %} â€” {{ m.numero_ordem }}{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" name="data" value="{{ selected.data }}">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">ğŸ” Procurar</button>
            </form>
        </div>

        {% if disponibilidades and disponibilidades|length > 0 %}
        <div class="content-section">
            <h2>Resultados ({{ disponibilidades|length }} disponibilidade{% if disponibilidades|length > 1 %}s{% endif %})</h2>
            {% for d in disponibilidades %}
            <div class="slot">
                <div class="slot-info">
                    <h4>{{ d.id_medico.id_utilizador.nome }}</h4>
                    <p>
                        ğŸ¥ {{ d.id_unidade.nome_unidade }}
                        | ğŸ”¬ {{ d.id_medico.id_especialidade.nome_especialidade }}
                        <br>
                        ğŸ“… {{ d.data|date:"d/m/Y" }}
                        â€¢ ğŸ•’ {{ d.hora_inicio }} - {{ d.hora_fim }}
                    </p>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="disponibilidade_id" value="{{ d.id_disponibilidade }}">
                    <div class="form-group" style="margin-top: 10px;">
                        <label for="hora_consulta_{{ d.id_disponibilidade }}">Selecione o horÃ¡rio de inÃ­cio:</label>
                        <select name="hora_consulta" id="hora_consulta_{{ d.id_disponibilidade }}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">Escolha um horÃ¡rio...</option>
                            {% for slot in d.time_slots %}
                                <option value="{{ slot.time }}" {% if not slot.available %}disabled{% endif %}>
                                    {{ slot.time }} {% if not slot.available %}(Ocupado){% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success" style="margin-top: 10px;">âœ… Marcar</button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% elif 'especialidade' in request.GET or 'unidade' in request.GET or 'medico' in request.GET or 'data' in request.GET %}
        <div class="content-section">
            <p style="text-align: center; color: #666; padding: 20px;">
                Nenhuma disponibilidade encontrada com esses filtros.<br>
                Tente alterar os filtros ou remover a data.
            </p>
        </div>
        {% endif %}
    </div>
</body>
</html>
