{% load static %}
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - M√©dico - MediPulse</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <style>
        #disponibilidade-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        #disponibilidade-modal .modal-content {
            background: white;
            padding: 0;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        #disponibilidade-modal .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #disponibilidade-modal .modal-header h3 {
            margin: 0;
            color: #ff6b6b;
        }
        
        #disponibilidade-modal .modal-body {
            padding: 20px;
        }
        
        #disponibilidade-modal .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        #disponibilidade-modal .modal-close:hover {
            color: #000;
        }
        
        /* Estilos para os itens de disponibilidade */
        .disponibilidade-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .disponibilidade-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .disponibilidade-item.disponivel {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .disponibilidade-item.indisponivel {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        .disponibilidade-item.ferias {
            background: #e2f1ff;
            border-left: 4px solid #17a2b8;
        }
        
        .disponibilidade-item.ocupado {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            opacity: 0.7;
        }
        
        .disponibilidade-item h4 {
            color: #333;
            margin: 0 0 5px 0;
        }
        
        .disponibilidade-item p {
            color: #666;
            font-size: 14px;
            margin: 0;
        }
        
        .disponibilidade-item .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .disponibilidade-item .btn-danger:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ Agenda M√©dica</h1>
            <div class="user-info">
                <span>Dr(a). {{ medico.id_utilizador.nome }}</span>
                <a href="{% url 'logout' %}" class="logout-btn">Sair</a>
            </div>
        </div>

        <div class="nav-menu">
            <a href="{% url 'medico_dashboard' %}">üìä Dashboard</a>
            <a href="{% url 'medico_agenda' %}" class="active">üìÖ Agenda</a>
            <a href="{% url 'home' %}">üè† Home</a>
        </div>

        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert {% if message.tags %}{{ message.tags }}{% else %}error{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('calendario', event)">üìÖ Calend√°rio</button>
                <button class="tab-button" onclick="switchTab('consultas', event)">üìã Consultas</button>
                <button class="tab-button" onclick="switchTab('agendar', event)">‚ûï Agendar Consulta</button>
                <button class="tab-button" onclick="switchTab('disponibilidade', event)">üïê Gerir Disponibilidade</button>
                <button class="tab-button" onclick="switchTab('ferias', event)">üö´ F√©rias/Aus√™ncias</button>
            </div>

            <!-- Tab 0: Calend√°rio -->
            <div id="calendario-tab" class="tab-content active">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">‚óÄ Anterior</button>
                        <h2 id="calendar-month-year"></h2>
                        <button class="calendar-nav" onclick="changeMonth(1)">Seguinte ‚ñ∂</button>
                    </div>
                    
                    <div class="calendar-grid">
                        <div class="calendar-day-header">Seg</div>
                        <div class="calendar-day-header">Ter</div>
                        <div class="calendar-day-header">Qua</div>
                        <div class="calendar-day-header">Qui</div>
                        <div class="calendar-day-header">Sex</div>
                        <div class="calendar-day-header">S√°b</div>
                        <div class="calendar-day-header">Dom</div>
                    </div>
                    <div class="calendar-grid" id="calendar-days"></div>

                    <div class="calendar-legend">
                        <div class="legend-item">
                            <div class="legend-color consulta"></div>
                            <span>Consultas</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color disponibilidade"></div>
                            <span>Disponibilidade</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color indisponibilidade"></div>
                            <span>Indisponibilidade</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Day Details Modal -->
            <div id="day-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modal-day-title"></h3>
                        <button class="modal-close" onclick="closeModal()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-section" id="modal-consultas-section">
                            <h4>üìã Consultas</h4>
                            <div id="modal-consultas"></div>
                        </div>
                        <div class="modal-section" id="modal-disponibilidade-section">
                            <h4>üïê Disponibilidade</h4>
                            <div id="modal-disponibilidade"></div>
                        </div>
                        <div class="modal-section" id="modal-indisponibilidade-section">
                            <h4>üö´ Indisponibilidade</h4>
                            <div id="modal-indisponibilidade"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 1: Consultas -->
            <div id="consultas-tab" class="tab-content">
                <form method="get" class="filter-form">
                    <input type="hidden" name="tab" value="consultas">
                    <label>
                        Per√≠odo:
                        <select name="periodo" onchange="this.form.submit()">
                            <option value="dia" {% if periodo == 'dia' %}selected{% endif %}>Dia</option>
                            <option value="semana" {% if periodo == 'semana' %}selected{% endif %}>Semana</option>
                            <option value="mes" {% if periodo == 'mes' %}selected{% endif %}>M√™s</option>
                        </select>
                    </label>
                    <label>
                        Data:
                        <input type="date" name="data_inicial" value="{{ data_inicial|date:'Y-m-d' }}" onchange="this.form.submit()">
                    </label>
                </form>

                <h3>üìã Consultas: {{ data_inicial|date:"d/m/Y" }} {% if periodo != 'dia' %}a {{ data_final|date:"d/m/Y" }}{% endif %}</h3>
                
                {% if consultas %}
                    <div class="timeline">
                        {% for consulta in consultas %}
                            <div class="timeline-item">
                                <div class="timeline-time">
                                    {{ consulta.hora_consulta }}<br>
                                    <small>{{ consulta.data_consulta|date:"d/m" }}</small>
                                </div>
                                <div class="timeline-content">
                                    <h4>
                                        {{ consulta.paciente_nome }}
                                        <span class="badge badge-{{ consulta.estado }}">
                                            {{ consulta.estado|title }}
                                        </span>
                                    </h4>
                                    <p>{{ consulta.motivo_consulta|default:"Sem motivo"|truncatewords:15 }}</p>
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                        {% if consulta.estado == 'agendada' %}
                                            <a href="{% url 'medico_confirmar_consulta' consulta.id_consulta %}" class="btn btn-success" style="background: #27ae60; color: white; padding: 6px 10px; font-size: 12px;">‚úÖ Confirmar</a>
                                            <a href="{% url 'medico_recusar_consulta' consulta.id_consulta %}" style="background: #e74c3c; color: white; padding: 6px 10px; font-size: 12px; border-radius: 5px; text-decoration: none; display: inline-block;">‚ùå Recusar</a>
                                        {% elif consulta.estado == 'confirmada' %}
                                            <a href="{% url 'medico_registar_consulta' consulta.id_consulta %}" class="btn btn-primary" style="background: #667eea; color: white; padding: 6px 10px; font-size: 12px;">üìù Registar</a>
                                            {% if consulta.can_cancel_24h %}
                                                <a href="{% url 'medico_cancelar_consulta' consulta.id_consulta %}" onclick="return confirm('Tem a certeza que deseja cancelar esta consulta?')" style="background: #e74c3c; color: white; padding: 6px 10px; font-size: 12px; border-radius: 5px; text-decoration: none; display: inline-block;">üö´ Cancelar</a>
                                            {% endif %}
                                        {% endif %}
                                        <a href="{% url 'medico_detalhes_consulta' consulta.id_consulta %}" style="background: #667eea; color: white; padding: 6px 10px; font-size: 12px; border-radius: 5px; text-decoration: none; display: inline-block;">Ver Detalhes</a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-data">Nenhuma consulta agendada para este per√≠odo.</div>
                {% endif %}
            </div>

            <!-- Tab 2: Agendar Consulta -->
            <div id="agendar-tab" class="tab-content">
                <div class="info-box">
                    <p><strong>‚ÑπÔ∏è Informa√ß√µes:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>A consulta ser√° criada com estado <strong>CONFIRMADA</strong></li>
                        <li>Se n√£o tiver disponibilidade no hor√°rio, ser√° solicitado a criar uma</li>
                        <li>Certifique-se de n√£o ter outras consultas no mesmo hor√°rio</li>
                        <li>O paciente poder√° visualizar a consulta na sua √°rea pessoal</li>
                    </ul>
                </div>

                <h3>‚ûï Nova Consulta</h3>
                <form method="post" id="agendar-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="agendar_consulta">
                    
                    <div class="form-group">
                        <label for="paciente_id">Paciente: *</label>
                        <select id="paciente_id" name="paciente_id" required>
                            <option value="">Selecione um paciente</option>
                            {% for paciente in pacientes %}
                            <option value="{{ paciente.id_paciente }}">
                                {{ paciente.nome }}
                                {% if paciente.n_utente %}
                                    (N¬∫ Utente: {{ paciente.n_utente }})
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="data_consulta">Data da Consulta: *</label>
                        <input type="date" id="data_consulta" name="data_consulta" required 
                               min="{{ hoje|date:'Y-m-d' }}">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="hora_inicio">In√≠cio da Consulta: *</label>
                            <input type="time" id="hora_inicio" name="hora_inicio" required>
                        </div>

                        <div class="form-group">
                            <label for="hora_fim">Fim da Consulta: *</label>
                            <input type="time" id="hora_fim" name="hora_fim" required>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">‚úÖ Agendar Consulta</button>
                </form>
            </div>

            <!-- Modal para criar disponibilidade -->
            <div id="disponibilidade-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>‚ö†Ô∏è Criar Disponibilidade</h3>
                        <button class="modal-close" onclick="closeDisponibilidadeModal()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <p>N√£o existe disponibilidade para o per√≠odo selecionado. Deseja criar uma disponibilidade que inclua este hor√°rio?</p>
                        
                        <form method="post" id="criar-disponibilidade-form">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="criar_disponibilidade_e_agendar">
                            <input type="hidden" id="modal-paciente-id" name="paciente_id">
                            <input type="hidden" id="modal-data" name="data_consulta">
                            <input type="hidden" id="modal-hora-inicio" name="hora_inicio">
                            <input type="hidden" id="modal-hora-fim" name="hora_fim">
                            
                            <div class="form-group">
                                <label for="modal-unidade">Unidade de Sa√∫de: *</label>
                                <select id="modal-unidade" name="unidade_id" required>
                                    <option value="">Selecione uma unidade</option>
                                    {% for u in unidades %}
                                    <option value="{{ u.id_unidade }}">{{ u.nome_unidade }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="modal-disp-inicio">In√≠cio da Disponibilidade:</label>
                                    <input type="time" id="modal-disp-inicio" name="disp_hora_inicio" required>
                                </div>

                                <div class="form-group">
                                    <label for="modal-disp-fim">Fim da Disponibilidade:</label>
                                    <input type="time" id="modal-disp-fim" name="disp_hora_fim" required>
                                </div>
                            </div>

                            <div class="form-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary">‚úÖ Criar e Agendar</button>
                                <button type="button" class="btn btn-secondary" onclick="closeDisponibilidadeModal()">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Disponibilidade -->
            <div id="disponibilidade-tab" class="tab-content">
                <div class="info-box">
                    <p>üí° Defina os dias e hor√°rios em que est√° dispon√≠vel para consultas. As disponibilidades ocupadas por consultas j√° marcadas N√ÉO aparecem nesta lista.</p>
                </div>

                <h3>‚ûï Adicionar Disponibilidade</h3>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="set_disponibilidade">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="unidade">Unidade de Sa√∫de: *</label>
                            <select id="unidade" name="unidade" required>
                                <option value="">Selecione uma unidade</option>
                                {% for u in unidades %}
                                <option value="{{ u.id_unidade }}">{{ u.nome_unidade }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="data">Data:</label>
                            <input type="date" id="data" name="data" required min="{{ hoje|date:'Y-m-d' }}">
                        </div>
                        <div class="form-group">
                            <label for="hora_inicio">Hora In√≠cio:</label>
                            <input type="time" id="hora_inicio" name="hora_inicio" required value="09:00">
                        </div>
                        <div class="form-group">
                            <label for="hora_fim">Hora Fim:</label>
                            <input type="time" id="hora_fim" name="hora_fim" required value="18:00">
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="disponivel" name="disponivel" checked onchange="toggleMotivo()">
                        <label for="disponivel" style="margin: 0;">‚úÖ Dispon√≠vel para consultas</label>
                    </div>

                    <div class="form-group" id="motivo-group" style="display: none;">
                        <label for="motivo_indisponibilidade">Motivo da Indisponibilidade:</label>
                        <input type="text" id="motivo_indisponibilidade" name="motivo_indisponibilidade" 
                               placeholder="Ex: Reuni√£o, Forma√ß√£o, etc.">
                    </div>

                    <button type="submit" class="btn btn-primary">üíæ Guardar</button>
                </form>

                <h3 style="margin-top: 30px;">üìã Disponibilidades Registadas</h3>
                {% if disponibilidades_futuras %}
                    {% for disp in disponibilidades_futuras %}
                        <div class="disponibilidade-item 
                            {% if disp.status_slot == 'disponivel' %}disponivel
                            {% elif disp.status_slot == 'indisponivel' %}indisponivel
                            {% elif disp.status_slot == 'ferias' %}ferias
                            {% else %}ocupado{% endif %}">
                            <h4>
                                {{ disp.data|date:"d/m/Y (l)" }}
                                {% if disp.status_slot == 'disponivel' %}
                                    ‚úÖ Dispon√≠vel
                                {% elif disp.status_slot == 'indisponivel' %}
                                    ‚ùå Indispon√≠vel
                                {% elif disp.status_slot == 'ferias' %}
                                    üèñÔ∏è F√©rias
                                {% elif disp.status_slot == 'booked' %}
                                    üìÖ Ocupado (com consulta)
                                {% else %}
                                    ‚ö†Ô∏è {{ disp.status_slot|title }}
                                {% endif %}
                            </h4>
                            <p>
                                ‚è∞ {{ disp.hora_inicio }} - {{ disp.hora_fim }}
                                {% if disp.id_unidade %}
                                    | üìç {{ disp.id_unidade.nome_unidade }}
                                {% endif %}
                            </p>
                            {% if disp.status_slot == 'disponivel' %}
                            <div style="margin-top: 10px;">
                                <form method="post" action="{% url 'medico_excluir_disponibilidade' disp.id_disponibilidade %}" 
                                      onsubmit="return confirm('Tem a certeza que deseja excluir esta disponibilidade?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-danger">
                                        üóëÔ∏è Excluir
                                    </button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="no-data">Nenhuma disponibilidade registada.</div>
                {% endif %}
            </div>

            <!-- Tab 4: F√©rias/Aus√™ncias -->
            <div id="ferias-tab" class="tab-content">
                <div class="info-box">
                    <p><strong>‚ÑπÔ∏è Informa√ß√£o:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Use este formul√°rio para registar per√≠odos de f√©rias ou aus√™ncias prolongadas</li>
                        <li>Todos os dias do per√≠odo selecionado ser√£o marcados como indispon√≠veis</li>
                        <li>Pacientes n√£o poder√£o marcar consultas durante este per√≠odo</li>
                    </ul>
                </div>

                <h3>üìÖ Registar Per√≠odo de F√©rias/Aus√™ncias</h3>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="set_ferias">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="data_inicio">Data In√≠cio:</label>
                            <input type="date" id="data_inicio" name="data_inicio" required min="{{ hoje|date:'Y-m-d' }}">
                        </div>
                        <div class="form-group">
                            <label for="data_fim">Data Fim:</label>
                            <input type="date" id="data_fim" name="data_fim" required min="{{ hoje|date:'Y-m-d' }}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="motivo">Motivo:</label>
                        <select id="motivo" name="motivo" required onchange="toggleOutroMotivo()">
                            <option value="F√©rias">F√©rias</option>
                            <option value="Licen√ßa m√©dica">Licen√ßa m√©dica</option>
                            <option value="Forma√ß√£o">Forma√ß√£o / Confer√™ncia</option>
                            <option value="Assuntos pessoais">Assuntos pessoais</option>
                            <option value="outro">Outro motivo</option>
                        </select>
                    </div>

                    <div class="form-group" id="outro-motivo" style="display: none;">
                        <label for="motivo_outro">Especifique o motivo:</label>
                        <input type="text" id="motivo_outro" name="motivo_outro" 
                               placeholder="Digite o motivo da aus√™ncia">
                    </div>

                    <button type="submit" class="btn btn-primary">üíæ Registar Indisponibilidade</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // @ts-nocheck
        // Calendar data from Django
        const consultasData = [
            {% for consulta in consultas_mes %}
            {
                id: {{ consulta.id_consulta }},
                date: '{{ consulta.data_consulta|date:"Y-m-d" }}',
                time: '{{ consulta.hora_consulta }}',
                patient: '{{ consulta.paciente_nome|escapejs }}',
                status: '{{ consulta.estado }}',
                canCancel: {{ consulta.can_cancel_24h|yesno:"true,false" }},
                type: 'consulta'
            },
            {% endfor %}
        ];

        const disponibilidadesData = [
            {% for disp in disponibilidades_mes %}
            {
                id: {{ disp.id_disponibilidade }},
                date: '{{ disp.data|date:"Y-m-d" }}',
                timeStart: '{{ disp.hora_inicio }}',
                timeEnd: '{{ disp.hora_fim }}',
                status: '{{ disp.status_slot|escapejs }}',
                type: {% if disp.status_slot == 'disponivel' %}'disponibilidade'{% else %}'indisponibilidade'{% endif %}
            },
            {% endfor %}
        ];

        let currentDate = new Date();

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update header
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Monday = 0
            
            // Get previous month's last days
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            // Build calendar
            let calendarHTML = '';
            let dayCounter = 1;
            let nextMonthCounter = 1;
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            const todayDate = today.getDate();
            
            // Total cells needed (6 rows * 7 days)
            const totalCells = 42;
            
            for (let i = 0; i < totalCells; i++) {
                let dayNum, dateStr, isOtherMonth = false, isToday = false;
                
                if (i < startingDayOfWeek) {
                    // Previous month
                    dayNum = prevMonthLastDay - startingDayOfWeek + i + 1;
                    const prevMonth = month === 0 ? 11 : month - 1;
                    const prevYear = month === 0 ? year - 1 : year;
                    dateStr = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
                    isOtherMonth = true;
                } else if (dayCounter <= daysInMonth) {
                    // Current month
                    dayNum = dayCounter;
                    dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
                    isToday = isCurrentMonth && dayNum === todayDate;
                    dayCounter++;
                } else {
                    // Next month
                    dayNum = nextMonthCounter;
                    const nextMonth = month === 11 ? 0 : month + 1;
                    const nextYear = month === 11 ? year + 1 : year;
                    dateStr = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
                    isOtherMonth = true;
                    nextMonthCounter++;
                }
                
                // Get events for this day
                const dayConsultas = consultasData.filter(c => c.date === dateStr);
                const dayDisponibilidades = disponibilidadesData.filter(d => d.date === dateStr && d.type === 'disponibilidade');
                const dayIndisponibilidades = disponibilidadesData.filter(d => d.date === dateStr && d.type === 'indisponibilidade');
                
                let eventsHTML = '';
                
                // Add consultas
                dayConsultas.forEach(consulta => {
                    eventsHTML += `<div class="calendar-event consulta" title="Consulta: ${consulta.patient} √†s ${consulta.time}">${consulta.time} ${consulta.patient}</div>`;
                });
                
                // Add disponibilidades (apenas as que n√£o est√£o ocupadas)
                dayDisponibilidades.forEach(disp => {
                    if (disp.status !== 'booked') {
                        eventsHTML += `<div class="calendar-event disponibilidade" title="Dispon√≠vel: ${disp.timeStart}-${disp.timeEnd}">‚úì ${disp.timeStart}-${disp.timeEnd}</div>`;
                    }
                });
                
                // Add indisponibilidades
                dayIndisponibilidades.forEach(disp => {
                    eventsHTML += `<div class="calendar-event indisponibilidade" title="Indispon√≠vel: ${disp.status || 'Sem motivo'}">${disp.status || 'Indispon√≠vel'}</div>`;
                });
                
                const todayClass = isToday ? ' today' : '';
                const otherMonthClass = isOtherMonth ? ' other-month' : '';
                
                calendarHTML += `
                    <div class="calendar-day${todayClass}${otherMonthClass}" onclick="openDayModal('${dateStr}', ${dayNum}, ${isOtherMonth ? 'true' : 'false'})">
                        <div class="calendar-day-number">${dayNum}</div>
                        ${eventsHTML}
                    </div>
                `;
            }
            
            document.getElementById('calendar-days').innerHTML = calendarHTML;
        }

        function openDayModal(dateStr, dayNum, isOtherMonth) {
            const modal = document.getElementById('day-modal');
            const dayConsultas = consultasData.filter(c => c.date === dateStr);
            const dayDisponibilidades = disponibilidadesData.filter(d => d.date === dateStr && d.type === 'disponibilidade' && d.status !== 'booked');
            const dayIndisponibilidades = disponibilidadesData.filter(d => d.date === dateStr && d.type === 'indisponibilidade');
            
            // Format date for display
            const [year, month, day] = dateStr.split('-');
            const date = new Date(year, month - 1, day);
            const dayNames = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const dateTitle = `${dayNames[date.getDay()]}, ${day} de ${monthNames[date.getMonth()]} de ${year}`;
            
            document.getElementById('modal-day-title').textContent = dateTitle;
            
            // Populate consultas
            const consultasSection = document.getElementById('modal-consultas-section');
            const consultasContainer = document.getElementById('modal-consultas');
            if (dayConsultas.length > 0) {
                consultasContainer.innerHTML = dayConsultas.map(c => `
                    <div class="modal-event-item consulta">
                        <strong>‚è∞ ${c.time}</strong>
                        <p><strong>Paciente:</strong> ${c.patient}</p>
                        <p><strong>Estado:</strong> <span class="badge badge-${c.status}">${c.status}</span></p>
                        ${c.status === 'confirmada' && c.canCancel ? `
                            <a href="/medico/consulta/${c.id}/cancelar/" 
                               onclick="return confirm('Tem a certeza que deseja cancelar esta consulta?')" 
                               style="background: #e74c3c; color: white; padding: 6px 10px; font-size: 12px; border-radius: 5px; text-decoration: none; display: inline-block; margin-top: 8px;">
                               üö´ Cancelar
                            </a>
                        ` : ''}
                    </div>
                `).join('');
                consultasSection.style.display = 'block';
            } else {
                consultasSection.style.display = 'none';
            }
            
            // Populate disponibilidade
            const dispSection = document.getElementById('modal-disponibilidade-section');
            const dispContainer = document.getElementById('modal-disponibilidade');
            if (dayDisponibilidades.length > 0) {
                dispContainer.innerHTML = dayDisponibilidades.map(d => `
                    <div class="modal-event-item disponibilidade">
                        <strong>‚úÖ Dispon√≠vel</strong>
                        <p>‚è∞ ${d.timeStart} - ${d.timeEnd}</p>
                    </div>
                `).join('');
                dispSection.style.display = 'block';
            } else {
                dispSection.style.display = 'none';
            }
            
            // Populate indisponibilidade
            const indispSection = document.getElementById('modal-indisponibilidade-section');
            const indispContainer = document.getElementById('modal-indisponibilidade');
            if (dayIndisponibilidades.length > 0) {
                indispContainer.innerHTML = dayIndisponibilidades.map(d => `
                    <div class="modal-event-item indisponibilidade">
                        <strong>‚ùå Indispon√≠vel</strong>
                        <p>‚è∞ ${d.timeStart} - ${d.timeEnd}</p>
                        ${d.status ? `<p><strong>Status:</strong> ${d.status}</p>` : ''}
                    </div>
                `).join('');
                indispSection.style.display = 'block';
            } else {
                indispSection.style.display = 'none';
            }
            
            // Show message if no events at all
            if (dayConsultas.length === 0 && dayDisponibilidades.length === 0 && dayIndisponibilidades.length === 0) {
                consultasContainer.innerHTML = '<div class="modal-no-data">Nenhum evento registado para este dia.</div>';
                consultasSection.style.display = 'block';
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('day-modal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('day-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            // Reload page with new month
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            window.location.href = `?cal_year=${year}&cal_month=${month}`;
        }

        function switchTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        function toggleMotivo() {
            const checkbox = document.getElementById('disponivel');
            const motivoGroup = document.getElementById('motivo-group');
            motivoGroup.style.display = checkbox.checked ? 'none' : 'block';
        }

        function toggleOutroMotivo() {
            const select = document.getElementById('motivo');
            const outroMotivo = document.getElementById('outro-motivo');
            outroMotivo.style.display = select.value === 'outro' ? 'block' : 'none';
        }

        // Set min date for data_fim when data_inicio changes
        document.getElementById('data_inicio')?.addEventListener('change', function() {
            document.getElementById('data_fim').min = this.value;
        });

        // Handle agendar consulta form submission
        document.getElementById('agendar-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const pacienteId = document.getElementById('paciente_id').value;
            const dataConsulta = document.getElementById('data_consulta').value;
            const horaInicio = document.getElementById('hora_inicio').value;
            const horaFim = document.getElementById('hora_fim').value;
            
            if (!pacienteId || !dataConsulta || !horaInicio || !horaFim) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }
            
            // Validate that fim is after inicio
            if (horaFim <= horaInicio) {
                alert('O fim da consulta deve ser posterior ao in√≠cio.');
                return;
            }
            
            // Check if disponibilidade exists via AJAX
            fetch('/medico/verificar-disponibilidade/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `data=${dataConsulta}&hora_inicio=${horaInicio}&hora_fim=${horaFim}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    // Disponibilidade exists, submit form directly
                    e.target.submit();
                } else {
                    // Show modal to create disponibilidade
                    showDisponibilidadeModal(pacienteId, dataConsulta, horaInicio, horaFim);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // If error, just submit the form
                e.target.submit();
            });
        });

        function showDisponibilidadeModal(pacienteId, data, horaInicio, horaFim) {
            document.getElementById('modal-paciente-id').value = pacienteId;
            document.getElementById('modal-data').value = data;
            document.getElementById('modal-hora-inicio').value = horaInicio;
            document.getElementById('modal-hora-fim').value = horaFim;
            
            // Pre-fill disponibilidade times (same as consulta or wider)
            document.getElementById('modal-disp-inicio').value = horaInicio;
            document.getElementById('modal-disp-fim').value = horaFim;
            
            document.getElementById('disponibilidade-modal').style.display = 'flex';
        }

        function closeDisponibilidadeModal() {
            document.getElementById('disponibilidade-modal').style.display = 'none';
        }

        // Close modal when clicking outside
        document.getElementById('disponibilidade-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeDisponibilidadeModal();
            }
        });

        // Initialize calendar on page load
        {% if cal_year and cal_month %}
        currentDate = new Date({{ cal_year }}, {{ cal_month }} - 1, 1);
        {% endif %}
        renderCalendar();
        
        // Restore active tab from URL parameter on page load
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('tab');
            
            if (activeTab) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Show the correct tab
                const tabContent = document.getElementById(activeTab + '-tab');
                if (tabContent) {
                    tabContent.classList.add('active');
                    
                    // Find and activate the corresponding button
                    const buttons = document.querySelectorAll('.tab-button');
                    buttons.forEach(btn => {
                        if (btn.onclick && btn.onclick.toString().includes("'" + activeTab + "'")) {
                            btn.classList.add('active');
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>
